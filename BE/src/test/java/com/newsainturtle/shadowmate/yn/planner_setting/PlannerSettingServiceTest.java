package com.newsainturtle.shadowmate.yn.planner_setting;

import com.newsainturtle.shadowmate.planner.repository.TodoRepository;
import com.newsainturtle.shadowmate.planner_setting.dto.request.*;
import com.newsainturtle.shadowmate.planner_setting.dto.response.*;
import com.newsainturtle.shadowmate.planner_setting.entity.Category;
import com.newsainturtle.shadowmate.planner_setting.entity.CategoryColor;
import com.newsainturtle.shadowmate.planner_setting.entity.Dday;
import com.newsainturtle.shadowmate.planner_setting.exception.PlannerSettingErrorResult;
import com.newsainturtle.shadowmate.planner_setting.exception.PlannerSettingException;
import com.newsainturtle.shadowmate.planner_setting.repository.CategoryColorRepository;
import com.newsainturtle.shadowmate.planner_setting.repository.CategoryRepository;
import com.newsainturtle.shadowmate.planner_setting.repository.DdayRepository;
import com.newsainturtle.shadowmate.planner_setting.service.PlannerSettingServiceImpl;
import com.newsainturtle.shadowmate.user.entity.User;
import com.newsainturtle.shadowmate.user.enums.PlannerAccessScope;
import com.newsainturtle.shadowmate.user.enums.SocialType;
import com.newsainturtle.shadowmate.user.repository.UserRepository;
import org.junit.jupiter.api.Nested;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.mockito.InjectMocks;
import org.mockito.Mock;
import org.mockito.junit.jupiter.MockitoExtension;

import java.sql.Date;
import java.util.ArrayList;
import java.util.List;
import java.util.Optional;

import static org.assertj.core.api.Assertions.assertThat;
import static org.junit.jupiter.api.Assertions.assertThrows;
import static org.mockito.ArgumentMatchers.any;
import static org.mockito.Mockito.*;

@ExtendWith(MockitoExtension.class)
class PlannerSettingServiceTest {

    @InjectMocks
    private PlannerSettingServiceImpl plannerSettingService;

    @Mock
    private CategoryRepository categoryRepository;

    @Mock
    private CategoryColorRepository categoryColorRepository;

    @Mock
    private DdayRepository ddayRepository;

    @Mock
    private UserRepository userRepository;

    @Mock
    private TodoRepository todoRepository;

    final User user = User.builder()
            .email("test@test.com")
            .password("123456")
            .socialLogin(SocialType.BASIC)
            .nickname("Í±∞Î∂ÅÏù¥")
            .plannerAccessScope(PlannerAccessScope.PUBLIC)
            .withdrawal(false)
            .build();

    @Nested
    class Ïπ¥ÌÖåÍ≥†Î¶¨ {
        @Nested
        class Ïπ¥ÌÖåÍ≥†Î¶¨Îì±Î°ù {
            final CategoryColor categoryColor = CategoryColor.builder()
                    .categoryColorCode("D9B5D9")
                    .build();
            final AddCategoryRequest request = AddCategoryRequest.builder()
                    .categoryTitle("Íµ≠Ïñ¥")
                    .categoryEmoticon("üçÖ")
                    .categoryColorId(1L)
                    .build();
            final Category category = Category.builder()
                    .id(1L)
                    .categoryTitle(request.getCategoryTitle())
                    .categoryEmoticon(request.getCategoryEmoticon())
                    .categoryRemove(false)
                    .categoryColor(categoryColor)
                    .user(user)
                    .build();

            @Test
            void Ïã§Ìå®_ÏóÜÎäîÏπ¥ÌÖåÍ≥†Î¶¨ÏÉâÏÉÅ() {
                //given
                doReturn(Optional.empty()).when(categoryColorRepository).findById(request.getCategoryColorId());

                //when
                final PlannerSettingException result = assertThrows(PlannerSettingException.class, () -> plannerSettingService.addCategory(user, request));

                //then
                assertThat(result.getErrorResult()).isEqualTo(PlannerSettingErrorResult.INVALID_CATEGORY_COLOR);
            }

            @Test
            void ÏÑ±Í≥µ_Ïπ¥ÌÖåÍ≥†Î¶¨Îì±Î°ù_Ïù¥Î™®Ìã∞ÏΩòÏóÜÏùå() {
                //given
                final AddCategoryRequest addCategoryRequest = AddCategoryRequest.builder()
                        .categoryTitle("Íµ≠Ïñ¥")
                        .categoryEmoticon(null)
                        .categoryColorId(1L)
                        .build();

                doReturn(Optional.of(categoryColor)).when(categoryColorRepository).findById(request.getCategoryColorId());
                doReturn(category).when(categoryRepository).save(any(Category.class));

                //when
                final AddCategoryResponse saveCategory = plannerSettingService.addCategory(user, addCategoryRequest);

                //then
                assertThat(saveCategory.getCategoryId()).isNotNull();
                assertThat(saveCategory.getCategoryId()).isEqualTo(1L);

                //verify
                verify(categoryColorRepository, times(1)).findById(request.getCategoryColorId());
                verify(categoryRepository, times(1)).save(any(Category.class));
            }

            @Test
            void ÏÑ±Í≥µ_Ïπ¥ÌÖåÍ≥†Î¶¨Îì±Î°ù_Ïù¥Î™®Ìã∞ÏΩòÏûàÏùå() {
                //given
                doReturn(Optional.of(categoryColor)).when(categoryColorRepository).findById(request.getCategoryColorId());
                doReturn(category).when(categoryRepository).save(any(Category.class));

                //when
                final AddCategoryResponse saveCategory = plannerSettingService.addCategory(user, request);

                //then
                assertThat(saveCategory.getCategoryId()).isNotNull();
                assertThat(saveCategory.getCategoryId()).isEqualTo(1L);

                //verify
                verify(categoryColorRepository, times(1)).findById(request.getCategoryColorId());
                verify(categoryRepository, times(1)).save(any(Category.class));
            }
        }

        @Nested
        class Ïπ¥ÌÖåÍ≥†Î¶¨ÏàòÏ†ï {
            final CategoryColor categoryColor = CategoryColor.builder()
                    .categoryColorCode("D9B5D9")
                    .build();
            final Category category = Category.builder()
                    .categoryTitle("ÏàòÌïô")
                    .categoryEmoticon("üåÄ")
                    .categoryRemove(false)
                    .categoryColor(categoryColor)
                    .user(user)
                    .build();
            final UpdateCategoryRequest request = UpdateCategoryRequest.builder()
                    .categoryId(1L)
                    .categoryTitle("Íµ≠Ïñ¥")
                    .categoryEmoticon("üçÖ")
                    .categoryColorId(1L)
                    .build();

            @Test
            void Ïã§Ìå®_ÏóÜÎäîÏπ¥ÌÖåÍ≥†Î¶¨() {
                //given
                doReturn(null).when(categoryRepository).findByUserAndId(user, request.getCategoryId());

                //when
                final PlannerSettingException result = assertThrows(PlannerSettingException.class, () -> plannerSettingService.updateCategory(user, request));

                //then
                assertThat(result.getErrorResult()).isEqualTo(PlannerSettingErrorResult.INVALID_CATEGORY);
            }

            @Test
            void Ïã§Ìå®_ÏóÜÎäîÏπ¥ÌÖåÍ≥†Î¶¨ÏÉâÏÉÅ() {
                //given
                doReturn(category).when(categoryRepository).findByUserAndId(user, request.getCategoryId());
                doReturn(Optional.empty()).when(categoryColorRepository).findById(request.getCategoryColorId());

                //when
                final PlannerSettingException result = assertThrows(PlannerSettingException.class, () -> plannerSettingService.updateCategory(user, request));

                //then
                assertThat(result.getErrorResult()).isEqualTo(PlannerSettingErrorResult.INVALID_CATEGORY_COLOR);
            }

            @Test
            void ÏÑ±Í≥µ_Ïπ¥ÌÖåÍ≥†Î¶¨Îì±Î°ù() {
                //given
                doReturn(category).when(categoryRepository).findByUserAndId(user, request.getCategoryId());
                doReturn(Optional.of(categoryColor)).when(categoryColorRepository).findById(request.getCategoryColorId());

                //when
                plannerSettingService.updateCategory(user, request);

                //then

                //verify
                verify(categoryColorRepository, times(1)).findById(request.getCategoryColorId());
                verify(categoryColorRepository, times(1)).findById(request.getCategoryColorId());
                verify(categoryRepository, times(1)).save(any(Category.class));
            }
        }

        @Nested
        class Ïπ¥ÌÖåÍ≥†Î¶¨ÏÑ§Ï†ï_Ï°∞Ìöå {
            final CategoryColor categoryColor = CategoryColor.builder()
                    .categoryColorCode("D9B5D9")
                    .build();
            final Long userId = 1L;
            final Category category = Category.builder()
                    .categoryColor(categoryColor)
                    .user(user)
                    .categoryTitle("Íµ≠Ïñ¥")
                    .categoryRemove(false)
                    .categoryEmoticon("üçÖ")
                    .build();

            @Test
            void Ïπ¥ÌÖåÍ≥†Î¶¨ÏÉâÏÉÅÎ™©Î°ùÏ°∞Ìöå() {
                //given
                final List<CategoryColor> list = new ArrayList<>();
                list.add(categoryColor);
                doReturn(list).when(categoryColorRepository).findAll();

                //when
                final GetCategoryColorListResponse result = plannerSettingService.getCategoryColorList();

                //then
                assertThat(result.getCategoryColorList()).isNotNull();
                assertThat(result.getCategoryColorList()).hasSize(1);
            }

            @Test
            void Ïπ¥ÌÖåÍ≥†Î¶¨Î™©Î°ùÏ°∞Ìöå() {
                //given
                final List<Category> list = new ArrayList<>();
                list.add(category);
                doReturn(list).when(categoryRepository).findByUserAndAndCategoryRemoveIsFalse(user);

                //when
                final GetCategoryListResponse result = plannerSettingService.getCategoryList(user);

                //then
                assertThat(result.getCategoryList()).isNotNull();
                assertThat(result.getCategoryList()).hasSize(1);
            }
        }

        @Nested
        class Ïπ¥ÌÖåÍ≥†Î¶¨ÏÇ≠Ï†ú {
            final CategoryColor categoryColor = CategoryColor.builder()
                    .categoryColorCode("D9B5D9")
                    .build();
            final Category category = Category.builder()
                    .categoryTitle("ÏàòÌïô")
                    .categoryEmoticon("üåÄ")
                    .categoryRemove(false)
                    .categoryColor(categoryColor)
                    .user(user)
                    .build();
            final RemoveCategoryRequest request = RemoveCategoryRequest.builder()
                    .categoryId(1L)
                    .build();

            @Test
            void Ïã§Ìå®_ÏóÜÎäîÏπ¥ÌÖåÍ≥†Î¶¨() {
                //given
                doReturn(null).when(categoryRepository).findByUserAndId(user, request.getCategoryId());

                //when
                final PlannerSettingException result = assertThrows(PlannerSettingException.class, () -> plannerSettingService.removeCategory(user, request));

                //then
                assertThat(result.getErrorResult()).isEqualTo(PlannerSettingErrorResult.INVALID_CATEGORY);
            }


            @Test
            void ÏÑ±Í≥µ_Ïπ¥ÌÖåÍ≥†Î¶¨_Ìï†ÏùºÏóêÏóÜÏùå() {
                //given
                doReturn(category).when(categoryRepository).findByUserAndId(user, request.getCategoryId());
                doReturn(0L).when(todoRepository).countByCategory(category);

                //when
                plannerSettingService.removeCategory(user, request);

                //then

                //verify
                verify(categoryRepository, times(1)).findByUserAndId(any(), any(Long.class));
                verify(todoRepository, times(1)).countByCategory(any(Category.class));
                verify(categoryRepository, times(1)).deleteByUserAndId(any(), any(Long.class));
            }

            @Test
            void ÏÑ±Í≥µ_Ïπ¥ÌÖåÍ≥†Î¶¨_Ìï†ÏùºÏóêÏûàÏùå() {
                //given
                doReturn(category).when(categoryRepository).findByUserAndId(user, request.getCategoryId());
                doReturn(1L).when(todoRepository).countByCategory(category);

                //when
                plannerSettingService.removeCategory(user, request);

                //then

                //verify
                verify(categoryRepository, times(1)).findByUserAndId(any(), any(Long.class));
                verify(todoRepository, times(1)).countByCategory(any(Category.class));
                verify(categoryRepository, times(1)).save(any(Category.class));
            }
        }
    }

    @Nested
    class ÌîåÎûòÎÑàÍ≥µÍ∞úÏó¨Î∂ÄÏÑ§Ï†ï {
        @Test
        void Ïã§Ìå®_ÏûòÎ™ªÎêúÎ≤îÏúÑÍ∞í() {
            //given
            final Long userId = 1L;
            final SetAccessScopeRequest request = SetAccessScopeRequest.builder()
                    .plannerAccessScope("ÏûòÎ™ªÎêúÎ≤îÏúÑÍ∞í")
                    .build();

            //when
            final PlannerSettingException result = assertThrows(PlannerSettingException.class, () -> plannerSettingService.setAccessScope(user, request));

            //then
            assertThat(result.getErrorResult()).isEqualTo(PlannerSettingErrorResult.INVALID_PLANNER_ACCESS_SCOPE);
        }

        @Test
        void ÏÑ±Í≥µ_ÌîåÎûòÎÑàÍ≥µÍ∞úÏó¨Î∂ÄÏÑ§Ï†ï() {
            //given
            final Long userId = 1L;
            final SetAccessScopeRequest request = SetAccessScopeRequest.builder()
                    .plannerAccessScope("ÎπÑÍ≥µÍ∞ú")
                    .build();

            //when
            plannerSettingService.setAccessScope(user, request);

            //then
            verify(userRepository, times(1)).save(any(User.class));
        }
    }

    @Nested
    class ÎîîÎç∞Ïù¥ {
        @Test
        void ÎîîÎç∞Ïù¥Îì±Î°ù_ÏÑ±Í≥µ() {
            //given
            final AddDdayRequest addDdayRequest = AddDdayRequest.builder()
                    .ddayTitle("ÏÉùÏùº")
                    .ddayDate("2023-02-09")
                    .build();
            final Dday dday = Dday.builder()
                    .id(1L)
                    .ddayTitle("ÏÉùÏùº")
                    .ddayDate(Date.valueOf("2023-02-09"))
                    .user(user)
                    .build();
            doReturn(dday).when(ddayRepository).save(any(Dday.class));

            //when
            AddDdayResponse addDdayResponse = plannerSettingService.addDday(user, addDdayRequest);

            //then
            assertThat(addDdayResponse.getDdayId()).isNotNull();
            assertThat(addDdayResponse.getDdayId()).isEqualTo(1L);

            //verity
            verify(ddayRepository, times(1)).save(any(Dday.class));
        }

        @Nested
        class ÎîîÎç∞Ïù¥Ï°∞Ìöå {
            @Test
            void Îì±Î°ùÎêúÎîîÎç∞Ïù¥Î™©Î°ùÏù¥ÏóÜÏùå() {
                //given
                final List<Dday> list = new ArrayList<>();
                doReturn(list).when(ddayRepository).findByUserOrderByDdayDateDesc(user);

                //when
                final GetDdayListResponse ddayListResponse = plannerSettingService.getDdayList(user);

                //then
                assertThat(ddayListResponse.getDdayList()).isNotNull();
                assertThat(ddayListResponse.getDdayList().size()).isEqualTo(0);
            }

            @Test
            void Îì±Î°ùÎêúÎîîÎç∞Ïù¥Î™©Î°ùÏù¥ÏûàÏùå() {
                //given
                final List<Dday> list = new ArrayList<>();
                list.add(Dday.builder()
                        .ddayTitle("ÏãúÌóò")
                        .ddayDate(Date.valueOf("2024-09-14"))
                        .user(user)
                        .build());
                list.add(Dday.builder()
                        .ddayTitle("ÏÉùÏùº")
                        .ddayDate(Date.valueOf("2023-02-09"))
                        .user(user)
                        .build());
                doReturn(list).when(ddayRepository).findByUserOrderByDdayDateDesc(user);

                //when
                final GetDdayListResponse ddayListResponse = plannerSettingService.getDdayList(user);

                //then
                assertThat(ddayListResponse.getDdayList()).isNotNull();
                assertThat(ddayListResponse.getDdayList()).hasSize(2);
            }
        }

        @Test
        void ÎîîÎç∞Ïù¥ÏÇ≠Ï†ú_ÏÑ±Í≥µ() {
            //given
            final User user = User.builder()
                    .email("test@test.com")
                    .password("123456")
                    .socialLogin(SocialType.BASIC)
                    .nickname("Í±∞Î∂ÅÏù¥")
                    .plannerAccessScope(PlannerAccessScope.PUBLIC)
                    .withdrawal(false)
                    .build();
            final RemoveDdayRequest removeDdayRequest = RemoveDdayRequest.builder()
                    .ddayId(1L)
                    .build();

            //when
            plannerSettingService.removeDday(user, removeDdayRequest);

            //then

            //verity
            verify(ddayRepository, times(1)).deleteByUserAndId(any(), any(Long.class));
        }

        @Nested
        class ÎîîÎç∞Ïù¥ÏàòÏ†ï {
            final UpdateDdayRequest request = UpdateDdayRequest.builder()
                    .ddayId(1L)
                    .ddayTitle("ÏãúÌóò")
                    .ddayDate("2023-09-18")
                    .build();
            final Dday dday = Dday.builder()
                    .ddayTitle("ÏÉùÏùº")
                    .ddayDate(Date.valueOf("2023-02-09"))
                    .user(user)
                    .build();

            @Test
            void Ïã§Ìå®_Ïú†Ìö®ÌïòÏßÄÏïäÏùÄÎîîÎç∞Ïù¥_Í∂åÌïúÏù¥ÏóÜÎäîÎîîÎç∞Ïù¥() {
                //given
                doReturn(null).when(ddayRepository).findByUserAndId(user, 1L);

                //when
                final PlannerSettingException result = assertThrows(PlannerSettingException.class, () -> plannerSettingService.updateDday(user, request));

                //then
                assertThat(result.getErrorResult()).isEqualTo(PlannerSettingErrorResult.INVALID_DDAY);
            }

            @Test
            void ÏÑ±Í≥µ() {
                //given
                doReturn(dday).when(ddayRepository).findByUserAndId(user, 1L);

                //when
                plannerSettingService.updateDday(user, request);

                //then

                //verify
                verify(ddayRepository, times(1)).findByUserAndId(user, 1L);
                verify(ddayRepository, times(1)).save(any(Dday.class));
            }
        }
    }
}